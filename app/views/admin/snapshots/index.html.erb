<% content_for :header do %>
    <%= link_to "Back to service", admin_service_path(params[:service_id]), class: "go-back" %>
    <h1 class="page-header__title">Edit history</h1>
<% end %>

<div class="snapshots">
    <aside class="snapshots__sidebar">
        <% if @snapshots.any? %>
            <ul class="snapshots-tree">
                <% @snapshots.each do |s| %>
                    <li class="snapshots-tree__snapshot" <%= "aria-selected" if s === @snapshots.first %>>

                        <h3 class="snapshots-tree__snapshot-title">
                            <%= link_to s.created_at.strftime('%d %B %Y, %H:%M'), "##{s.id}", class: "snapshots-tree__snapshot-link", data: { no_turbolink: true } %>
                        </h3>

                        <% if s === @snapshots.first %>
                            <p><em>Current version</em><p>
                        <% end %>
                        
                        <% if s === @snapshots.last %>
                            <p><em>Earliest version</em><p>
                        <% end %>

                        <% if s.user %>
                            <p class="snapshots-tree__snapshot-user"><%= s.user.display_name %></p>
                        <% end %>

                        <% unless s.action === "update"%>
                            <p class="snapshots-tree__snapshot-action">
                                <%= s.action.humanize %>
                            </p>
                        <% end %>

                    </li>
                <% end %>
            </ul>
        <% end %>
    </aside>

    <div class="snapshots__previews">
        <% if @snapshots.any? %>
            <% @snapshots.each do |s| %>
                <article class="snapshot-preview" id="<%= s.id %>" <%= "hidden" unless s === @snapshots.first %> >
                    <% unless s === @snapshots.first %>
                        <div class="snapshot-preview__actions">
                            <%= link_to "Restore this version", admin_service_snapshot_path(@service, s), method: "patch", data: {confirm: "Are you sure you want to restore this version? This will overwrite more recent changes."}, class: "button button--small" %>
                        </div>
                    <% end %>

                    <div class="snapshot-preview__canvas">

                        <h2><%= s.object["name"] %></h2>

                        <p><%= s.object["description"] %></p>

                        <h3>Parent organisation</h3>
                        <p><%= Organisation.find(s.object["organisation_id"]).name %></p>

                        <h3>Website URL</h3>
                        <p><%= s.object["url"] %></p>

                        <h3>Website URL</h3>
                        <p><%= s.object["url"] %></p>

                        <h3>Email</h3>
                        <p><%= s.object["email"] %></p>

                        <h3>Categories</h3>
                        <p><%= s.object["taxonomies"].map { |h| h["name"] }.join(", ") %></p>

                        <h3>Locations</h3>
                        <p><%= s.object["locations"].map { |h| h["postal_code"] }.join(", ") if s.object["locations"].present? %></p>

                        <h3>SEND Needs</h3>
                        <p><%= s.object["send_needs"].map { |h| h["name"] }.join(", ") %></p>
                        
                        <h3>Visible from</h3>
                        <p><%= s.object["visible_from"] %></p>

                        <h3>Visible to</h3>
                        <p><%= s.object["visible_to"] %></p>
                    </div>



                </article>
            <% end %>
        <% end %>
    </div>
</div>